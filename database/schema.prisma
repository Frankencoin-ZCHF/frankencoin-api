// FrancEco API Database Schema
// Supports optional database via DISABLE_DATABASE env var

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// APP-SPECIFIC DATA (Replacing Storj S3)
// Persistent storage for telegram groups, prices, and analytics
// Blockchain data is always fetched from Ponder instances, never from database
// ============================================================================

// Telegram group subscriptions and state
model TelegramGroup {
  id            String   @id @default(uuid())
  chatId        String   @unique
  title         String?
  subscriptions Json     // { MintingUpdates: true, PriceAlerts: true, ... }
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([chatId])
  @@map("telegram_groups")
}

model TelegramIgnore {
  id        String   @id @default(uuid())
  chatId    String   @unique
  createdAt DateTime @default(now())

  @@map("telegram_ignore")
}

// Price query cache (current prices)
model PriceCache {
  id        String   @id @default(uuid())
  data      Json     // PriceQueryObjectArray
  cachedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("price_cache")
}

// Price history - one row per timestamp
// Data structure: {<address>: price_chf, <address>: price_chf, ...}
model PriceHistory {
  id        String   @id @default(uuid())
  timestamp BigInt   @unique
  prices    Json     // Simple mapping: {[address]: price_chf}
  cachedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([timestamp])
  @@map("price_history")
}

// Price history ratio - one row per timestamp
model PriceHistoryRatio {
  id                          String   @id @default(uuid())
  timestamp                   BigInt   @unique
  collateralRatioByFreeFloat  Float
  collateralRatioBySupply     Float
  cachedAt                    DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  @@index([timestamp])
  @@map("price_history_ratio")
}

// Ecosystem total supply history
// Data structure: {<timestamp>: {created, supply, allocation: {<chainId>: amount}}}
model EcosystemSupply {
  id        String   @id @default(uuid())
  data      Json     // Complete supply history object keyed by timestamp
  cachedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ecosystem_supply")
}

// ============================================================================
// INDEXER HEALTH TRACKING
// Monitors primary and backup indexer status
// ============================================================================

model IndexerHealth {
  id                  String    @id @default(uuid())
  indexerUrl          String    @unique
  indexerType         String    // "primary" or "backup"
  chainId             Int       @default(1)
  blockNumber         BigInt
  blockTimestamp      Int
  isHealthy           Boolean
  lastCheckedAt       DateTime  @default(now())
  lastSuccessAt       DateTime?
  lastFailureAt       DateTime?
  consecutiveFailures Int       @default(0)

  @@index([indexerUrl])
  @@index([isHealthy])
  @@index([lastCheckedAt])
  @@map("indexer_health")
}
